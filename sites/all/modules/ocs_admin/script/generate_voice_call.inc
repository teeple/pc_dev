#!/usr/bin/env drush                      
<?php

$case = array(
array('   1. MTC_DDD','97688778899','976011111','Voice','2013-01-05 15:00','60','60'),
array('   2. MTC_UB','97688778899','97611','Voice','2013-01-05 15:00','60','60'),
array('   3. MTC_WLL','97688778899','976901111','Voice','2013-01-05 15:00','60','60'),
array('   4. MOBICOM','97688778899','976991111','Voice','2013-01-05 15:00','60','60'),
array('   5. MOBI_WLL','97688778899','97695111111','Voice','2013-01-05 15:00','60','60'),
array('   6. SKYTEL','97688778899','97691141111','Voice','2013-01-05 15:00','60','60'),
array('   7. SKY_WLL','97688778899','97696111111','Voice','2013-01-05 15:00','60','60'),
array('   8. RAILWAY','97688778899','976023621','Voice','2013-01-05 15:00','60','60'),
array('   9. AIRPORT','97688778899','9760112811','Voice','2013-01-05 15:00','60','60'),
array('  10. GVRMNT1','97688778899','976920011','Voice','2013-01-05 15:00','60','60'),
array('  11. GVRMNT2','97688778899','976512611','Voice','2013-01-05 15:00','60','60'),
array('  12. GVRMNT3','97688778899','976622611','Voice','2013-01-05 15:00','60','60'),
array('  13. UNITEL','97688778899','97688909693','Voice','2013-01-05 15:00','60','0'),
array('  14. UNITEL_VOIP','97688778899','97689111111','Voice','2013-01-05 15:00','60','0'),
array('  15. UNITEL_new','97688778899','97686111111','Voice','2013-01-05 15:00','60','0'),
array('  16. MTC_INT','97688778899','001821097971731','Voice','2013-01-05 15:00','60','594'),
array('  17. SKY_INT','97688778899','002821097971731','Voice','2013-01-05 15:00','60','568'),
array('  18. MOBI_INT','97688778899','003821097971731','Voice','2013-01-05 15:00','60','450'),
array('  19. INFO_195','97688778899','9761951111','Voice','2013-01-05 15:00','60','350'),
array('  20. INFO_2','97688778899','9761881111','Voice','2013-01-05 15:00','60','60'),
array('  21. INFO_3','97688778899','9761901111','Voice','2013-01-05 15:00','60','350'),
array('  22. INFO_193','97688778899','9761931111','Voice','2013-01-05 15:00','60','350'),
array('  23. INFO_5','97688778899','9761921111','Voice','2013-01-05 15:00','60','350'),
array('  24. INFO_6','97688778899','9761961111','Voice','2013-01-05 15:00','60','350'),
array('  25. INFO_7','97688778899','9761611111','Voice','2013-01-05 15:00','60','350'),
array('  26. INFO_8','97688778899','9761980111','Voice','2013-01-05 15:00','60','60'),
array('  27. RAILWAY_UB','97688778899','976211111','Voice','2013-01-05 15:00','60','60'),
array('  28. MTC_WLLnew','97688778899','976501111','Voice','2013-01-05 15:00','60','60'),
array('  29. MOBI_WLLnew','97688778899','976551111','Voice','2013-01-05 15:00','60','60'),
array('  30. INFO_191','97688778899','9761910111','Voice','2013-01-05 15:00','60','350'),
array('  31. RAY_INT','97688778899','005821097971731','Voice','2013-01-05 15:00','60','565'),
array('  32. MONGOLCOM','97688778899','9761681111','Voice','2013-01-05 15:00','60','60'),
array('  33. MTC_NGN','97688778899','976701111','Voice','2013-01-05 15:00','60','60'),
array('  34. INFO_10','97688778899','9761971111','Voice','2013-01-05 15:00','60','350'),
array('  35. Popularcom','97688778899','976588111','Voice','2013-01-05 15:00','60','60'),
array('  36. G-Mobile','97688778899','97698111111','Voice','2013-01-05 15:00','60','60'),
array('  37. INFO_12','97688778899','976014321801','Voice','2013-01-05 15:00','60','350'),
array('  38. MOBI_DIAL','97688778899','9761691111','Voice','2013-01-05 15:00','60','60'),
array('  39. Khubsgul_in','97688778899','976013821801','Voice','2013-01-05 15:00','60','350'),
array('  40. TEST','97688778899','97614291111','Voice','2013-01-05 15:00','60','0'),
array('  41. INFO_13','97688778899','9761941111','Voice','2013-01-05 15:00','60','350'),
array('  42. Skynetwork','97688778899','97677111111','Voice','2013-01-05 15:00','60','60'),
array('  43. G_Mobile','97688778899','97693111111','Voice','2013-01-05 15:00','60','60'),
array('  44. MTC_INFO','97688778899','976110911','Voice','2013-01-05 15:00','60','350'),
array('  45. Inkomnet','97688778899','976118111111','Voice','2013-01-05 15:00','60','138'),
array('  46. INFO_14','97688778899','9761891111','Voice','2013-01-05 15:00','60','60'),
array('  47. INFO_Dornod','97688778899','9760158218011','Voice','2013-01-05 15:00','60','350'),
array('  48. Inkomnet_1','97688778899','976118121111','Voice','2013-01-05 15:00','60','138'),
array('  49. Garts_1','97688778899','9761622111','Voice','2013-01-05 15:00','60','60'),
array('  50. Garts_2','97688778899','976163611','Voice','2013-01-05 15:00','60','60'),
array('  51. Garts_3','97688778899','97616471','Voice','2013-01-05 15:00','60','60'),
array('  52. Garts_4','97688778899','976165811','Voice','2013-01-05 15:00','60','60'),
array('  53. Garts_5','97688778899','976166011','Voice','2013-01-05 15:00','60','60'),
array('  54. Garts_6','97688778899','976167011','Voice','2013-01-05 15:00','60','60'),
array('  55. INFO_15','97688778899','976014621802','Voice','2013-01-05 15:00','60','350'),
array('  56. Garts_12','97688778899','976128811','Voice','2013-01-05 15:00','60','60'),
array('  57. Nalaih','97688778899','97601231922','Voice','2013-01-05 15:00','60','350'),
array('  58. Info_199','97688778899','976199211','Voice','2013-01-05 15:00','60','350'),
array('  59. Info_17','97688778899','976014421801','Voice','2013-01-05 15:00','60','350'),
array('  60. UNI_INT','97688778899','008821097971731','Voice','2013-01-05 15:00','60','605'),
array('  61. nalaih_in','97688778899','97601211800','Voice','2013-01-05 15:00','60','350'),
array('  62. Info_Darhan','97688778899','976013721802','Voice','2013-01-05 15:00','60','350'),
array('  63. Info_Darhan_Upd','97688778899','97670371802','Voice','2013-01-05 15:00','60','350'),
array('  64. Info_Dorngovi','97688778899','9760152218001','Voice','2013-01-05 15:00','60','350'),
array('  65. MOBINET','97688778899','9767575','Voice','2013-01-05 15:00','60','60'),
array('  66. Info_180','97688778899','9761801111','Voice','2013-01-05 15:00','60','350'),
array('  67. Sky_Voip','97688778899','976761111','Voice','2013-01-05 15:00','60','60'),
array('  68. GobiInfo','97688778899','976015321800','Voice','2013-01-05 15:00','60','250'),
array('  69. Orkhon_Asgat','97688778899','976013521808','Voice','2013-01-05 15:00','60','350'),
array('  70. Orkhon_Asgat_70','97688778899','97670351808','Voice','2013-01-05 15:00','60','350'),
array('  71. MonSat','97688778899','97679881808','Voice','2013-01-05 15:00','60','60'),
array('  72. INFO_Dund_govi','97688778899','976015921801','Voice','2013-01-05 15:00','60','350'),
array('  73. MOBI_NEW','97688778899','97694111808','Voice','2013-01-05 15:00','60','60'),
array('  74. Info_Uvurhangai','97688778899','9760132581800','Voice','2013-01-05 15:00','60','350'),
array('  75. G_Mobile_53','97688778899','97653151808','Voice','2013-01-05 15:00','60','60'),
array('  76. G_Mobile_97','97688778899','97697151808','Voice','2013-01-05 15:00','60','60'),
array('  77. Info_Baganuur','97688778899','97601211855','Voice','2013-01-05 15:00','60','350'),
array('  78. ZuunKharaa_in','97688778899','9760236471800','Voice','2013-01-05 15:00','60','350'),
array('  79. Ganaa_Test','97688778899','9766688','Voice','2013-01-05 15:00','60','70'),
array('  80. Unitel_Ayalguu','97688778899','9761435','Voice','2013-01-05 15:00','60','100'),
array('  81. MTD_LLC','97688778899','97670441802','Voice','2013-01-05 15:00','60','350'),
array('  82. INFO_12_70','97688778899','97670431801','Voice','2013-01-05 15:00','60','350'),
array('  83. INFO_Darkhan_19','97688778899','97670351907','Voice','2013-01-05 15:00','60','350'),
array('  84. Selenge_Info','97688778899','97670361801','Voice','2013-01-05 15:00','60','350'),
array('  85. G_Mobile_78','97688778899','97678151808','Voice','2013-01-05 15:00','60','60'),
array('  86. eeverich','97688778899','97670211801','Voice','2013-01-05 15:00','60','350'),
array('  87. Dornodzuuch','97688778899','97670581801','Voice','2013-01-05 15:00','60','350'),
array('  88. Goviin_javkhaa','97688778899','97670481801','Voice','2013-01-05 15:00','60','350'),
array('  89. UNITEL TIMEID2 22~24','97688778899','97688909693','Voice','2013-01-07 5:00','60','0'),
array('  90. UNITEL TIMEID2 HOLIDAY 22~24','97688778899','97688909693','Voice','2013-01-07 5:00','60','0'),
array('  91. UNITEL_VOIP TIMEID2 22~24','97688778899','97689111111','Voice','2013-01-07 5:00','60','0'),
array('  92. UNITEL_VOIP TIMEID2 HOLIDAY 22~24','97688778899','97689111111','Voice','2013-01-07 5:00','60','0'),
array('  93. UNITEL_new TIMEID2 22~24','97688778899','97686111111','Voice','2013-01-07 5:00','60','0'),
array('  94. UNITEL_new TIMEID2 HOLIDAY 22~24','97688778899','97686111111','Voice','2013-01-07 5:00','60','0'),
array('  95. MTC_INT TIMEID2 20~24','97688778899','001821097971731','Voice','2013-01-07 5:00','60','528'),
array('  96. RAY_INT TIMEID2 20~24','97688778899','005821097971731','Voice','2013-01-07 5:00','60','510'),
array('  97. SKY_INT TIMEID2 00~06','97688778899','002821097971731','Voice','2013-01-07 5:00','60','488'),
array('  98. MOBI_INT TIMEID2 00~09','97688778899','003821097971731','Voice','2013-01-07 5:00','60','360'),
array('  99. UNI_INT TIMEID2 00~09','97688778899','008821097971731','Voice','2013-01-07 5:00','60','495'),
	);

$subs = array(
		array( '428880300001696', '100000136020', '97688000011'),
		array( '428880300001697', '100000136021', '97688000012'),
		array( '428880300001698', '100000136022', '97688000005'),
		array( '428880300001699', '100000136023', '97688000006'),
		array( '428880300001700', '100000136024', '97688000007'),
		array( '428880300001701', '100000136025', '97688000008'),
		array( '428880300001702', '100000136026', '97688000009'),
		array( '428880300001694', '100000136018', '97688003002'),
		array( '428880300001695', '100000136019', '97688003004'),
		array( '428880300001693', '100000136017', '97688003000'),
		array( '428880300001690', '100000136013', '97687003000'),
		array( '428880300001691', '100000136014', '97688003001'),
		array( '428880300001692', '100000136015', '97688003003'),
		);


$nl = '
';

$user = array(
		"subscription_key" => "428880111011135", 
		"user_key" => "97688788899", 
		"product_id" => "fce_prepaid_A", 
		"origId" => "97688788899", 
		"accountId" => "97688788899" 
		);


foreach( $subs as $s) {
	$user['subscription_key'] = $s[0];
	$user['user_key'] = $user['origId'] = $user['accountId'] = $s[2];

	// first recharge
	recharge( $user);

	foreach( $case as $tc) {
		$node = _get_node_by_title( $tc[0]);

		$stime = new DateTime();
		$node->field_ts_starttime['und'][0]['value'] = $stime->format('YmdHis');
		$duration = rand( 3, 300);
		$etime = $stime->add( new DateInterval('PT'.$duration.'S'));
		$node->field_ts_endtime['und'][0]['value'] = $etime->format('YmdHis');

		$output = ocs_run_testcase_http( 'http://10.21.8.70:8085/ocs/subscriber/' . $user['user_key'] . '/directdebit', $node, NULL, 'POST', '', '', $user);
		$response = $output['response'];
		$result = json_decode( $response->data);
		if ( $result->result_code != '0') {
			print $tc[0] . ' : FAIL' . $nl;
			print_r( $output);
			if ( $result->result_reason == 'NOT_ENOUGH_BALANCE') {
				recharge( $user);
			}
		}
		else {
			print $tc[0] . ' : SUCCESS' . $nl;
		}
	}
}

function recharge( $user)
{
	$nl = '
';
	$recharge_template = node_load( 60016);
	$recharge_template->field_recharge_type['und'][0]['value'] = 3;

	$output = ocs_run_testcase_http( 'http://10.21.8.70:8085/ocs/subscriber/' . $user['subscription_key'] . '/recharge', 
			$recharge_template, NULL, 'POST', '{"recharge":', '}', $user);
	$response = $output['response'];
	$result = json_decode( $response->data);
	if ( $result->result_code != '0') {
		print 'Recharge : FAIL' . $nl;
	}
	else {
		print 'Recharge : SUCCESS' . $nl;
	}
}


// return array of nodes
function _get_node_by_title( $title)
{
	$query = new EntityFieldQuery();
	$result = $query->entityCondition('entity_type', 'node')
		->entityCondition('bundle', 'test_case_online_charging')
		->propertyCondition('title', $title)
		->execute();

	if ( count( $result) > 0) {
		$nids = array_keys( $result['node']);
		$node = node_load( $nids[0]);
		return $node;
	}

	return NULL;
}
