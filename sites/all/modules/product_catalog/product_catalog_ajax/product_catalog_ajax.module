<?php
module_load_include('inc', 'product_catalog_ajax', 'custom_submit');
module_load_include('inc', 'product_catalog_ajax', 'create_modal_link');
// ---------------------------------------------------------------------------
// Drupal hooks.
// jangsun
 
/**
 *  Implementation of hook_menu()
 */
function product_catalog_ajax_menu() {

  $items['product_catalog_ajax/%ctools_js/add'] = array(
      'title' => 'Add New',
      'page callback' => 'product_catalog_ajax_add_content',
      'page arguments' => array(1),
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,  
  );     
  $items['product_catalog_ajax/%ctools_js/add_modal/%'] = array( 
      'title' => 'Add New',
      'page callback' => 'product_catalog_ajax_add_modal_content',
      'page arguments' => array(1,3),
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
  );
  $items['product_catalog_ajax/%ctools_js/select_modal/%'] = array( 
      'title' => 'Add New',
      'page callback' => 'product_catalog_ajax_select_modal_content',
      'page arguments' => array(1,3),
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
  );
  $items['product_catalog_ajax/select_modal_item/%'] = array( 
      'title' => 'Select Modal Item',
      'page callback' => 'product_catalog_ajax_select_modal_item_submit',
      'page arguments' => array(2),
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
  );
  $items['product_catalog_ajax/delete_from_view/%'] = array(
      'title' => 'Delete',
      'page callback' => 'product_catalog_ajax_delete_from_view',
      'page arguments' => array(2),
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
  );
  $items['product_catalog_ajax/%ctools_js/edit/%'] = array(
      'title' => 'Edit',
      'page callback' => 'product_catalog_ajax_edit_content',
      'page arguments' => array(1,3),
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
  ); 
  $items['product_catalog_ajax/%ctools_js/edit_modal/%'] = array(
      'title' => 'Edit',
      'page callback' => 'product_catalog_modal_form_edit_modal_content',
      'page arguments' => array(1,3),
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
  );  
  $items['product_catalog_ajax/view_modal/%'] = array(
  		'title' => 'View',
  		'page callback' => 'product_catalog_modal_form_view',
  		'page arguments' => array(2),
  		'access callback' => TRUE,
  		'type' => MENU_CALLBACK,
  );
  $items['product_catalog_ajax/modal_view_link/%'] = array(
  		'title' => 'View',
  		'page callback' => 'product_catalog_modal_view_link',
  		'page arguments' => array(2),
  		'access callback' => TRUE,
  		'type' => MENU_CALLBACK,
  );
  $items['product_catalog_ajax/%ctools_js/delete_from_tree'] = array(
      'title' => 'Delete',
      'page callback' => 'product_catalog_ajax_delete_from_tree',
      'page arguments' => array(1),
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
  );
  $items['product_catalog_ajax/%ctools_js/loadTree/%'] = array(
      'title' => 'Load Tree',
      'page callback' => 'product_catalog_ajax_load_tree',
      'page arguments' => array(1,3),
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
  );
  $items['product_catalog_ajax/%ctools_js/move_node'] = array(
      'title' => 'Edit',
      'page callback' => 'product_catalog_ajax_move_node',
      'page arguments' => array(1),
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
  );
  $items['product_catalog_ajax/load_select_form/%'] = array(
      'title' => 'Select Form',
      'page callback' => 'product_catalog_ajax_load_select_form',
      'page arguments' => array(2),
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
  );
  $items['product_catalog_ajax/select_item'] = array(
  	  'title' => 'Select Form Submit',
      'page callback' => 'product_catalog_ajax_select_submit',
      //'page arguments' => array(2),
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
  );
  $items['product_catalog_ajax/custom_submit'] = array(
  		'title' => 'Custom Submit',
  		'page callback' => 'product_catalog_ajax_custom_submit',
  		//'page arguments' => array(2),
  		'access callback' => TRUE,
  		'type' => MENU_CALLBACK,
  );
  $items['product_catalog_ajax/counter_list'] = array(
  		'title' => 'Set Counter List',
  		'page callback' => 'product_catalog_ajax_counter_list',
  		'access callback' => TRUE,
  		'type' => MENU_CALLBACK,
  );
  $items['product_catalog_ajax/set_rollover'] = array(
  		'title' => 'Set Rollover',
  		'page callback' => 'product_catalog_ajax_set_rollover',
  		'access callback' => TRUE,
  		'type' => MENU_CALLBACK,
  );
  $items['product_catalog_ajax/copy_node/%'] = array(
      'title' => 'Copy',
      'page callback' => 'product_catalog_ajax_copy_node',
      'page arguments' => array(2),
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
  );
  $items['product_catalog_ajax/paste_node/%'] = array(
      'title' => 'Paste',
      'page callback' => 'product_catalog_ajax_paste_node',
      'page arguments' => array(2),
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
  );
  return $items;

} 

function _paste_tariffplan($targetNode,$productNid,$baseIdType,$baseIdValue,$weight){
    $targetRefTreeTid = $targetNode->field_ref_tree_tid['und'][0]['value'];
    if($targetRefTreeTid != $baseIdValue){//error
        $output['success'] = FALSE;
        $targetRefTreeTerm = taxonomy_term_load($targetRefTreeTid);
        $baseIdTerm = taxonomy_term_load($baseIdValue);
        if($targetRefTreeTerm->name != $baseIdTerm->name){
            $output['reason'] = $targetRefTreeTerm->name . ' tariffplan can not be pasted to '. $baseIdTerm->name . ' tariffplan';
        }else{
            $targetRefTermVocaName = $targetRefTreeTerm->vocabulary_machine_name;
            $baseTermVocaName = $baseIdTerm->vocabulary_machine_name;
            $targetRefTermVocaName = explode('_',$targetRefTermVocaName);
            $baseTermVocaName = explode('_',$baseTermVocaName);
            
            if($targetRefTermVocaName[3] != $baseTermVocaName[3]){//service domain
                $output['reason'] = 'tariffplan of '. $targetRefTermVocaName[3]. ' service domain can not be pasted to '. $baseTermVocaName[3] .' service domain';
            }else if($targetRefTermVocaName[5] != $baseTermVocaName[5]){// billing type
                $output['reason'] = 'tariffplan of '. $targetRefTermVocaName[5]. ' billtype can not be pasted to '. $baseTermVocaName[5] .' billtype';
            }
        }                
    }else{//success
        dsm($targetNode,'target node');
        //create tariffplan node
        $tariffplanNode = new StdClass();     
        $tariffplanNode->uid = $user->uid;
        $tariffplanNode->type = 'tariffplan';
        $tariffplanNode->language = 'und';
        $tariffplanNode->field_weight['und'][0]['value'] = $weight;
        $tariffplanNode->field_ref_product['und'][0]['nid'] = $productNid;
        $tariffplanNode->field_ref_tree_tid = $targetNode->field_ref_tree_tid;
        $tariffplanNode->field_tree_child_voca_name = $targetNode->field_tree_child_voca_name;
        $tariffplanNode->field_ref_numberingplan_domestic = $targetNode->field_ref_numberingplan_domestic;
        $tariffplanNode->field_ref_numberingplan_idd = $targetNode->field_ref_numberingplan_idd;
        $tariffplanNode->field_ref_timetable_domestic = $targetNode->field_ref_timetable_domestic;
        $tariffplanNode->field_valid_date_ymd = $targetNode->field_valid_date_ymd;
        $tariffplanNode->field_valid_date_hour = $targetNode->field_valid_date_hour;
        $tariffplanNode->field_ref_numberspecial = $targetNode->field_ref_numberspecial;
        $tariffplanNode->field_ref_roaming_plan = $targetNode->field_ref_roaming_plan;
        
        //$tariffplanNode->field_ref_tariffplan_idd_carrier = $targetNode->field_ref_tariffplan_idd_carrier;
        
        //node_save($tariffplanNode);
        
        $output['success'] = TRUE;    
    }  

    return $output;
};

function product_catalog_ajax_paste_node($nodeId,$productId,$weight){
    ctools_include('node.pages', 'node', '');
    ctools_include('ajax');
    global $user;
    
    $targetNid = session_get('copy_target_nid');
    $productNid = explode('_', $productId);
    $productNid = $productNid[1];
    $baseId = explode('_',$nodeId);
    $baseIdType = $baseId[0];
    $baseIdValue = $baseId[1];
    
    if($targetNid == NULL){
        $output['success'] = FALSE;
        $output['reason'] = 'There is no copied item';
    }else{
        $targetNode = node_load($targetNid);    
        if($targetNode->type == 'tariffplan'){
            $output = _paste_tariffplan($targetNode,$productNid,$baseIdType,$baseIdValue,$weight);              
        }
    }
    print json_encode($output);
    exit;
};

function product_catalog_ajax_copy_node($nodeId){
    ctools_include('ajax');
    $nid = explode('_',$nodeId);
    $nid = $nid[1];
    
    //$copyNode = node_load($nid);
    session_set('copy_target_nid',$nid);
        
    //$output = $copyNode->title . ' has been copied';
    $output = 'success';
    print json_encode($output);
    exit;
}

function product_catalog_ajax_select_modal_item_submit($contentTypes) {
	global $user;
	ctools_include('node.pages', 'node', '');
	ctools_include('modal');
	ctools_include('ajax');
	  
	$source_nid = $_POST['source_nid'];
	$nids = $_POST['nids'];
	$defaultTabIndex = $_POST['default_tab_index'];
	  
	foreach($nids as $nid) {
		$actionsetnotification = new StdClass(); 
  	
		$actionsetnotification->uid = $user->uid;
		$actionsetnotification->type = 'actionsetnotification';
		$actionsetnotification->language = 'und';
		
		$actionsetnotification->field_ref_source_action['und'][0]['nid'] = $source_nid;
		$actionsetnotification->field_ref_messages['und'][0]['nid'] = $nid;
		
		node_save($actionsetnotification);
	}
  
	$output[] = ctools_modal_command_dismiss(t('Success'));
	$output = ajax_render($output);
	  
	print $output;
	exit;	
}
 
function _create_qtabs_for_counter($nid, $args) {
    $productNid = get_root($nid);
    $product = node_load($productNid);
    $billing_type = taxonomy_term_load($product->field_billing_type['und'][0]['tid']);
    $service_domain = taxonomy_term_load($product->field_service_type_of_provider['und'][0]['tid']);
   
    if($billing_type->name == 'HYBRID') {
        $args[2] = 'all';
    } else {
        $args[2] = $billing_type->name;
    }
    $args[3] = $service_domain->name;

    $qtabs = array(
      array(
        'title' => t('Counter Selection'),
        'type' => 'view',
        'vid' => 'list_counter',
        'display' => 'panel_pane_3',
        'args' => join('/',$args),	// dummy args.
        'weight' => 0,
      ),
    );
    return $qtabs;
}

function product_catalog_ajax_counter_list() {
	
	global $user;
	$tempProductNid = explode('_',$_POST['product_nid']);
	$productNid = $tempProductNid[1];
	
	$counterNids = $_POST['counter_nids'];
	
	$params = array('0' => $productNid);
	$view = views_get_view('list_prdcounterlist');
	$view->set_display('panel_pane_1');
	$view->set_arguments($params);
	$view->execute();
	
	$record = current($view->result);
	$prdcounterlist = node_load($record->nid);
	
	if(isset($prdcounterlist->field_counter_list) 
		&& !empty($prdcounterlist->field_counter_list['und'])) {
		unset($prdcounterlist->field_counter_list['und']);
	};
	
	foreach($counterNids as $counterNid) {
		$prdcounterlist->field_counter_list['und'][] = array('nid' => $counterNid);
	}
	
	node_save($prdcounterlist);
	
	$js_settings = array(
		'success' => TRUE,
		'data' => 'success'
	);
		  
	drupal_add_js(array('product_catalog_ajax_result' => $js_settings), 'setting');
	  
	$renderOutput = '';
	$output[] = $renderOutput;
	$output = ajax_render($output);
	  
	print $output;
	exit;
}

function product_catalog_ajax_set_rollover() {
	
	global $user;
	$tempProductNid = explode('_',$_POST['product_nid']);
	$productNid = $tempProductNid[1];
	
	$nodeNid = $_POST['rollover_nid'];
	$rolloverWeight = $_POST['rollover_weight'];
	$rolloverRefProduct = $_POST['rollover_ref_product'];
	$rolloverRefTreeNid = $_POST['rollover_ref_tree_nid'];
	$rolloverRefTreeTid = $_POST['rollover_ref_tree_tid'];
	
	$counterNids = $_POST['counter_nids'];
	$rolloverFlag = $_POST['rollover_flag'];
	$happens = $_POST['happens'];
	$addOrReplace = $_POST['add_or_replace'];
	
	if(empty($nodeNid)) {
		$prdnonusagerollover = new StdClass();
		$prdnonusagerollover->uid = $user->uid;
		$prdnonusagerollover->type = 'prdnonusagerollover';
		$prdnonusagerollover->language = 'und';
		
		$prdnonusagerollover->field_ref_product['und'][0]['nid'] = $productNid;
		$prdnonusagerollover->field_ref_tree_tid['und'][0]['value'] = $rolloverRefTreeTid;
		$prdnonusagerollover->field_weight['und'][0]['value'] = $rolloverWeight;
		
	} else {
		$prdnonusagerollover = node_load($nodeNid);
	}
	
	if(isset($prdnonusagerollover->field_counter_list) 
		&& !empty($prdnonusagerollover->field_counter_list['und'])) {
		unset($prdnonusagerollover->field_counter_list['und']);
	};
	
	foreach($counterNids as $counterNid) {
		$prdnonusagerollover->field_counter_list['und'][] = array('nid' => $counterNid);
	}
	
	$prdnonusagerollover->field_user_for_rollover['und'][0]['value'] = isset($rolloverFlag)? $rolloverFlag: '0';
	$prdnonusagerollover->field_rollover_add_or_replace['und'][0]['value'] = isset($addOrReplace)? $addOrReplace: '0';
	$prdnonusagerollover->field_happens['und'][0]['value'] = isset($happens)? $happens: 'week';
	
	/*
	$product = node_load($productNid);
	$voca_name = _get_vocabulary_name('simpleproductoffering', $product);
	$terms = taxonomy_get_term_by_name('Rollover', $voca_name);
	$rollover_tid = current($terms)->tid;
	*/
	node_save($prdnonusagerollover);
	
	$jquery_select_id = 'node_'.$nodeNid;
	
	$js_settings = array(
		'success' => TRUE,
		'data' => array(
				'parentId' => 'term_'.$rolloverRefTreeTid.'_'.$productNid,
				'childId' => 'node_'.$prdnonusagerollover->nid,
				'title' => 'PrdNonUsageRollover',
				'contentType' => 'prdnonusagerollover',
				'weight' => $rolloverWeight
			),
	);
		  
	drupal_add_js(array('product_catalog_ajax_result' => $js_settings), 'setting');
	  
	$renderOutput = '';
	$output[] = $renderOutput;
	$output = ajax_render($output);
	
	print $output;
	exit;
}

function product_catalog_ajax_select_modal_content($js = NULL, $contentType, $nid, $defaultTabIndex) {
	ctools_include('node.pages', 'node', '');
	ctools_include('modal');
	ctools_include('ajax');
	ctools_modal_add_js();
	
	if($contentType == 'actionsetnotification') {
		$renderedView = views_embed_view('list_messages', 'panel_pane_1');
	}
	
	$output = array();
	$renderOutput = '<div id="modal_content" style="overflow:scroll;height:700px;">'.$renderedView.'</div>';
	
	$output[] = ctools_modal_command_display('Notification Message Selection', $renderOutput);
	$output[] = ajax_command_invoke(NULL, 'selectModalButtonBinding', array('0' => $renderOutput, '1' => $nid, '2' => $defaultTabIndex));
	
	$output = ajax_render($output);
	print $output;
	exit;
}
  
function product_catalog_ajax_add_modal_content($js = NULL, $contentType, $refNodeNid, $refTreeTid) {
	global $user;
	ctools_include('node.pages', 'node', '');
	ctools_include('modal');
	ctools_include('ajax');
	
	$node = (object) array(
			'uid' => $user->uid,
			'name' => (isset($user->name) ? $user->name : ''),
			'type' => $contentType,
			'language' => 'und',			
	);
	$form_state = array();

	switch($contentType){
		case 'rate':
			$node->field_ref_tariffplan['und'][0]['nid'] = $refNodeNid;
			$node->field_ref_tree_tid['und'][0]['value'] = $refTreeTid;
			break;
		case 'domestic_ratinggroup':
			$node->field_ref_numberingplan_domestic['und'][0]['nid'] = $refNodeNid;
			break;
		case 'idd_ratinggroup':
			$node->field_ref_numberingplan_idd['und'][0]['nid'] = $refNodeNid;
			break;
        case 'roaming_ratinggroup':
            $node->field_ref_roaming_plan['und'][0]['nid'] = $refNodeNid;
            break;
		case 'depositschemefactors':
		case 'depositschemeadjustment':
			$node->field_ref_depositscheme['und'][0]['nid'] = $refNodeNid;
			break;
		case 'thresholdschemefactors':
			$node->field_ref_thresholdscheme['und'][0]['nid'] = $refNodeNid;
			break;
		case 'loyaltypointfactors':
			$viewResult = views_get_view_result('list_loyaltypoint', 'panel_pane_1',$refNodeNid);
			$node->field_ref_loyaltypoint['und'][0]['nid'] = current($viewResult)->nid;
			break;
		case 'ocs_state_machine':
			$node->title = $refNodeNid;
			$node->field_lifecycle_scheme['und'][0]['nid'] = $refNodeNid;
			break;
		case 'actionsetcounter':
		case 'actionsetcounteronbonus':
			$node->title = 'source_'.$refNodeNid;
			$node->field_ref_source_action['und'][0]['nid'] = $refNodeNid;
			
			$refNode = node_load($refNodeNid);
			$form_state['product_nid'] = $refNode->field_ref_product['und'][0]['nid'];
			break;

		case 'holidaylist_repeatable':
		case 'holidaylist_specific':
			$form_state['holidaylist_nid']= $refNodeNid;
			
			break;
		
		case 'numberspecialfactors':
			$node->field_ref_numberspecial['und'][0]['nid'] = $refNodeNid;
			break;
	}
	
	if (!$js) {
		return drupal_get_form($contentType . '_node_form', $node);
	}
	$form_state['title'] = 'Add a new '.$contentType;
	$form_state['ajax'] = 'TRUE';
		
	$form_state['build_info']['args'] = array($node);
	$formName = $contentType . '_node_form';

	$output = ctools_modal_form_wrapper($formName, $form_state);

	if (!empty($form_state['executed'])) {
		$output = array();
		//$output[] = ctools_modal_command_display(t('Node created'),'<div class="modal-message">Node creation successful.</div>');
		$output[] = ctools_modal_command_dismiss();
		
		switch($contentType){
			case 'domestic_ratinggroup':
				$planNode = node_load($refNodeNid);
				$planNode->field_ref_domestic_ratinggroup['und'][] = array('nid' => $form_state['values']['nid']);
				node_save($planNode);
				$output[] = ctools_ajax_command_reload();
				break;
			case 'idd_ratinggroup':
				$planNode = node_load($refNodeNid);
				$planNode->field_ref_idd_ratinggroup['und'][] = array('nid' => $form_state['values']['nid']);
				node_save($planNode);
				$output[] = ctools_ajax_command_reload();
				break;
            case 'roaming_ratinggroup':
                $planNode = node_load($refNodeNid);
                $planNode->field_ref_roaming_ratinggroup['und'][] = array('nid' => $form_state['values']['nid']);
                node_save($planNode);
                $output[] = ctools_ajax_command_reload();
                break;
			case 'numberspecialfactors':
				$output[] = _add_command_after_dismiss_modal($refNodeNid,$refTreeTid);
				break;
			case 'depositschemefactors':
			case 'depositschemeadjustment':
			case 'thresholdschemefactors':
			case 'area_code':
			case 'ocs_state_machine':
			case 'holidaylist_repeatable':
			case 'holidaylist_specific':
				$output[] = ctools_ajax_command_reload();
				break;
			case 'actionsetcounter':
			case 'actionsetcounteronbonus':
				$defaultTabIndex = $refTreeTid;
				$refTreeTid = NULL;
				$output[] = _add_command_after_dismiss_modal($refNodeNid,$refTreeTid,$defaultTabIndex);
				break;
			
			default : //for tree
				$output[] = _add_command_after_dismiss_modal($refNodeNid,$refTreeTid);
				break;
		}
		
		//dsm($output,'output');
	}
	else{
		if($contentType == 'rate'){
			$output[] = ajax_command_invoke(NULL, 'drawFlotLinkInit');
		}
	}
	
	print ajax_render($output);
	exit;	
}

function product_catalog_ajax_select_submit() {
  global $user;
  
  $productNid = $_POST['product_nid'];
  $parentNid = $_POST['parent_nid'];
  $parentTitle = $_POST['parent_title'];
  $childNids = $_POST['child_nid'];
  $max_weight = $_POST['max_weight'];
  $min_weight = $_POST['min_weight'];
  $rel_type = $_POST['rel_type'];
  
  $weightStep = -100;
  $weight = $min_weight;
  
  $js_data = array();
  $js_data['parent_nid'] = $parentNid;
  $js_data['replace_or_append'] = 'append';
  $js_data['children'] = array();
  
  $tmpParentNid = explode('_', $parentNid);
  $tmpProductNid = explode('_',$productNid);
  
  foreach($childNids as $childNid) {
      $child = new StdClass();
      $child->uid = $user->uid;
      $child->language = 'und';
     
      if($tmpParentNid[0] == 'node') {
        $child->field_parent_node = array('und' => array(0 => array('nid' => $tmpParentNid[1])));
      } else if($tmpParentNid[0] == 'term') {
      	$child->field_ref_tree_tid = array('und' => array(0 => array('value' => $tmpParentNid[1])));
      }

      $weight += $weightStep;

      switch($rel_type) {
      case 'mobile_nonusage_unittransfer_scheme':
      	_remove_existing_children($tmpProductNid[1], $tmpParentNid[1]);
      	
      	$child->type = 'treenodeunittransferscheme';
      	$child->field_weight['und'][0]['value'] = $weight;
      	$child->field_ref_product['und'][0]['nid'] = $tmpProductNid[1];
      	$child->field_ref_unittransfer['und'][0]['nid'] = $childNid;
      	
      	node_save($child);
      	 
      	$js_data['parent_title'] = $child->title;
      	$js_data['append_to'] = 'inside';
      	$js_data['replace_or_append'] = 'replace';
      	
      	break;
	  case 'mobile_attribute_subscriber_lifecycle_scheme':
		_remove_existing_children($tmpProductNid[1], $tmpParentNid[1]);
      	
      	$child->type = 'treenodelifecyclescheme';
      	$child->field_weight['und'][0]['value'] = $weight;
      	$child->field_ref_product['und'][0]['nid'] = $tmpProductNid[1];
      	$child->field_lifecycle_scheme['und'][0]['nid'] = $childNid;
      	
      	node_save($child);
      	 
      	$js_data['parent_title'] = $child->title;
      	$js_data['append_to'] = 'inside';
      	$js_data['replace_or_append'] = 'replace';
      	break;
	  case 'mobile_counter_main':
      	$child->type = 'treenodecounter';
      	
      	$term_tree = taxonomy_get_term_by_name('Main', 'countermainoraccu');
      	$child->field_main_or_accumulated['und'][0]['tid'] = current($term_tree)->tid;
      	
      	$child->field_ref_counter['und'][0]['nid'] = $childNid;
      	$child->field_weight['und'][0]['value'] = $weight;
      	$child->field_ref_product['und'][0]['nid'] = $tmpProductNid[1];
      	node_save($child);
      	$js_data['append_to'] = 'last';
      	break;
      	
	  case 'mobile_counter_accumulated':
        $child->type = 'treenodecounter';
        
        $term_tree = taxonomy_get_term_by_name('Accumulated', 'countermainoraccu');
        $child->field_main_or_accumulated['und'][0]['tid'] = current($term_tree)->tid;
         
        $child->field_ref_counter['und'][0]['nid'] = $childNid;
        $child->field_weight['und'][0]['value'] = $weight;           
        $child->field_ref_product['und'][0]['nid'] = $tmpProductNid[1];
        
        node_save($child);
        $js_data['append_to'] = 'last';
        break;
        
      case 'mobile_packaged_mandatory':
      	$child->type = 'prdattributepackaged';
      	$child->field_weight['und'][0]['value'] = $weight;
      	$child->field_ref_product['und'][0]['nid'] = $tmpProductNid[1];
      	$child->field_ref_connected_product['und'][0]['nid'] = $childNid;
      	
      	// $term = taxonomy_term_load($tmpParentNid[1]);
      	$term = taxonomy_get_term_by_name('Mandatory_MarketOpen','prdrelationtype');
      	$child->field_ref_prdrelationtype['und'][0]['tid'] = current($term)->tid;
      	
      	node_save($child);
      	$js_data['append_to'] = 'inside';
      	break;
      case 'cross_available_product':
  		$child->type = 'prdattributepackaged';
  		$child->field_weight['und'][0]['value'] = $weight;
  		$child->field_ref_product['und'][0]['nid'] = $tmpProductNid[1];
  		$child->field_ref_connected_product['und'][0]['nid'] = $childNid;
  	
  		// $term = taxonomy_term_load($tmpParentNid[1]);
  		$term = taxonomy_get_term_by_name('Mandatory_MarketOpen','prdrelationtype');
  		$child->field_ref_prdrelationtype['und'][0]['tid'] = current($term)->tid;
  	
  		node_save($child);
  		$js_data['append_to'] = 'inside';
  	  break;
      case 'mobile_packaged_optional':
      	$child->type = 'prdattributepackaged';
      	$child->field_weight['und'][0]['value'] = $weight;
      	$child->field_ref_product['und'][0]['nid'] = $tmpProductNid[1];
      	$child->field_ref_connected_product['und'][0]['nid'] = $childNid;
      	
      	$term = taxonomy_get_term_by_name('Optional', 'prdrelationtype');
      	$child->field_ref_prdrelationtype['und'][0]['tid'] = current($term)->tid;
      	
      	node_save($child);
      	$js_data['append_to'] = 'inside';
        break;
      	 
      case 'mobile_packaged_hidden':
		  
      	$child->type = 'prdattributepackaged';
      	$child->field_weight['und'][0]['value'] = $weight;
      	$child->field_ref_product['und'][0]['nid'] = $tmpProductNid[1];
      	$child->field_ref_connected_product['und'][0]['nid'] = $childNid;
      	
		$term = taxonomy_get_term_by_name('Mandatory_MarketHidden','prdrelationtype');
      	$child->field_ref_prdrelationtype['und'][0]['tid'] = current($term)->tid;
      	
      	node_save($child);
		
      	$js_data['append_to'] = 'inside';
      	break;
      	
      case 'voucher_product_specific':
      	$child->type = 'treenodeproductforvoucher';
      	$child->field_weight['und'][0]['value'] = $weight;
      	$child->field_ref_vouchercardtype['und'][0]['nid'] = $tmpProductNid[1];
      	$child->field_ref_product['und'][0]['nid'] = $childNid;
      	
      	node_save($child);
      	
      	_create_treenodecounterforvoucherprd($child, $childNid);
      	
      	$js_data['append_to'] = 'inside';
      	break;

      case 'mobile_nonusage_deposit':
      	
      	_remove_existing_children($tmpProductNid[1], $tmpParentNid[1]);
      	 
      	$child->type = 'treenodedepositscheme';
      	$child->field_weight['und'][0]['value'] = $weight;
      	$child->field_ref_product['und'][0]['nid'] = $tmpProductNid[1];
      	$child->field_ref_depositscheme['und'][0]['nid'] = $childNid;
      	 
      	node_save($child);
      	
      	$js_data['parent_title'] = $child->title;
      	$js_data['append_to'] = 'inside';
      	$js_data['replace_or_append'] = 'replace';
      	break;

      case 'mobile_nonusage_threshold':
      	
      	_remove_existing_children($tmpProductNid[1], $tmpParentNid[1]);
      	
      	$child->type = 'treenodethresholdscheme';
      	$child->field_weight['und'][0]['value'] = $weight;
      	$child->field_ref_product['und'][0]['nid'] = $tmpProductNid[1];
      	$child->field_ref_thresholdscheme['und'][0]['nid'] = $childNid;
      	
      	node_save($child);
      	
      	$js_data['parent_title'] = $child->title;
      	$js_data['append_to'] = 'inside';
      	$js_data['replace_or_append'] = 'replace';
      	break;
      	
      case 'mobile_nonusage_recharge_additional':
      	$child->type = 'treenodevouchercardforproduct';
      	$child->field_weight['und'][0]['value'] = $weight;
      	$child->field_ref_product['und'][0]['nid'] = $tmpProductNid[1];
      	$child->field_ref_vouchercardtype['und'][0]['nid'] = $childNid;
      	 
      	node_save($child);
      	
      	$js_data['append_to'] = 'inside';
      	break;
      case 'mobile_nonusage_otheronetimecharge':
        $child->type = 'treenodeotheronetimecharge';
        $child->field_weight['und'][0]['value'] = $weight;
        $child->field_ref_product['und'][0]['nid'] = $tmpProductNid[1];
        $child->field_ref_otherontimecharge['und'][0]['tid'] = $childNid;
        node_save($child);        
        $js_data['append_to'] = 'inside';
      break;
      case 'voice_tariffplan_specialnumber':
      case 'sms_tariffplan_specialnumber':
        $planNode = node_load($tmpParentNid[2]);
        if(isset($planNode->field_ref_numberspecial['und'][0]['nid'])){
            node_delete($planNode->field_ref_numberspecial['und'][0]['nid']);
        }
        
        $child->type = 'treenodespecialnumberscheme';
        $child->field_weight['und'][0]['value'] = $weight;
        $child->field_ref_product['und'][0]['nid'] = $tmpProductNid[1];
        $child->field_ref_numberspecial['und'][0]['nid'] = $childNid;
        $child->field_ref_tree_nid['und'][0]['nid'] = $planNode->nid;
        node_save($child);        
        $planNode->field_ref_numberspecial['und'][0]['nid'] = $child->nid;
        node_save($planNode);
        $js_data['parent_title'] = $child->title;
        $js_data['append_to'] = 'inside';
        $js_data['replace_or_append'] = 'replace';
        break;
      case 'data_tariffplan_predefined':
        $planNode = node_load($tmpParentNid[2]);
        $child->type = 'treenodepacketpredefined';
        $child->field_weight['und'][0]['value'] = $weight;
        $child->field_ref_product['und'][0]['nid'] = $tmpProductNid[1];
        $child->field_ref_tree_nid['und'][0]['nid'] = $planNode->nid;
        $child->field_ref_packet_predefined['und'][0]['nid'] = $childNid;
        $child->field_ref_tariffplan['und'][0]['nid'] = $planNode->nid;
        node_save($child);        
        $js_data['append_to'] = 'inside'; 
        break;
      case 'data_tariffplan_dynamic':
        $planNode = node_load($tmpParentNid[2]);
        $child->type = 'treenodepacketdynamic';
        $child->field_weight['und'][0]['value'] = $weight;
        $child->field_ref_product['und'][0]['nid'] = $tmpProductNid[1];
        $child->field_ref_tree_nid['und'][0]['nid'] = $planNode->nid;
        $child->field_ref_packet_dynamic['und'][0]['nid'] = $childNid;
        $child->field_ref_tariffplan['und'][0]['nid'] = $planNode->nid;
        node_save($child);        
        $js_data['append_to'] = 'inside'; 
        break;
      }
      $js_data['children'][] = get_children_stored_procedure($child->nid,$parentNid);
  }

  $js_settings = array(
  	'success' => TRUE,
	'data' => $js_data
  );
  
// dsm($js_settings, 'js_settings');
  
  drupal_add_js(array('product_catalog_ajax_result' => $js_settings), 'setting');
  
  $renderOutput = '';
  $output[] = $renderOutput;
  $output = ajax_render($output);
  
  print $output;
  exit;
}

function _remove_existing_children($root_nid, $refTreeTid) {
	$nodes = get_1st_children_nids_by_in_tree($root_nid, $refTreeTid);
	node_delete_multiple($nodes);
	
}

// 선택된 product의 counter만큼
// 
function _create_treenodecounterforvoucherprd($treenodeproductforvoucher, $productNid){
	global $user;
	
	// 해당 상품의 optional counter를 가져옴.
	// 	
	$params = array('0' => $productNid);
	$view = views_get_view('list_prdcounterlist');
	$view->set_display('panel_pane_2');
	$view->set_arguments($params);
	$view->execute();
	
	$counterList = array();
	foreach($view->result as $record){
		$counterList[] = view_get_field_value_by_label($view, 'qtabConfigNid', $record);
	}
	
	// 해당 상품의 basic counter를 가져옴.
	$product = node_load($productNid);

	$term_counter_type = taxonomy_get_term_by_name('Basic', 'countertype');
	$term_service_domain_tid = $product->field_service_type_of_provider['und'][0]['tid'];
	$term_billing_type_product = taxonomy_term_load($product->field_billing_type['und'][0]['tid']);
		
    $args[0] = current($term_counter_type)->tid;
	$args[1] = $term_service_domain->tid;
	if($term_bill_type_product->name == 'Hybrid') {
		$args[2] = 'all';
			
	} else {
		$term_billing_type_counter = taxonomy_get_term_by_name($term_billing_type_product->name, 'billtypecounter');
		$args[2] = $term_billing_type_counter->tid;
	}

    $view = views_get_view('query_list_counter');
    $view->set_display('panel_pane_1');
    $view->set_arguments($args);
    $view->execute();
    
    foreach($view->result as $record){
        $counterList[] = $record->nid;
	}
	
	foreach($counterList as $record) {
		
		$treenodecounterforvoucherprd = new StdClass();
		$treenodecounterforvoucherprd->type = 'treenodecounterforvoucherprd';
		$treenodecounterforvoucherprd->uid = $user->uid;
		$treenodecounterforvoucherprd->language = 'und';
		$treenodecounterforvoucherprd->field_ref_counter['und'][0]['nid'] = $record;
		$treenodecounterforvoucherprd->field_ref_treenodeproductforvouc['und'][0]['nid'] = $treenodeproductforvoucher->nid;
		node_save($treenodecounterforvoucherprd);
	}
	
}

// [arg], [Exclude]일 경우, 해당 collection name에 해당하는 qtab configration을 읽어서 replace arg를 위한 result값을 보내준다.
// 
function _get_view_result_qtabConfgNid($collectionName, $args) {

	$resultArr = array();
	$qtabConfigs = _qtabconfig_loading($collectionName, $args['termInTree']);
	
	if(isset($args['qtabIndex'])) {
		$qtabConfig = $qtabConfigs[$collectionName][$args['qtabIndex']];
	} else {
		$qtabConfig = $qtabConfigs[$collectionName][0];
	}
	
	$tmpView = views_get_view($qtabConfig['content']);
	
	$view = views_get_view($qtabConfig['content']);
	$view->set_display($qtabConfig['display']);
	
	if(isset($qtabConfig['args'])) {
		$newArgs = _replace_arguments($qtabConfig['args'], $qtabConfig, $args);
	}
	$tempArgs = explode('/', $newArgs);
	
	foreach($tempArgs as $tmpArg){
		$arguments[] = $tmpArg;
	}
	
	$view->set_arguments($arguments);
	$view->execute();
	$results = $view->result;
	
	foreach($results as $record) {
		$resultArr[] = view_get_field_value_by_label($view, 'qtabConfigNid', $record);
	}
	
	return $resultArr;
}

// 	$args = array(
// 			'qtabIndex' => $qtabIndex,
// 			'termInTree' => $termInTree,
// 			'id' => $id,
// 			'rootId' => $rootId
// 	);
function _replace_arguments($origArgs, $qtabConfig, $args) {

	$newArgString = $origArgs;
	$qtabConfigArgList = explode('/', $origArgs);
	$reservedArgList = array('$productNid', '$tariffplanNid','$voucherCardTypeNid','$nid', '$numberSpecialNid','$numberSpecialNidForDetail','[arg]', '[Exclude]', '[Include]', '$refTreeTid');

	$matchedArgList = array_intersect($qtabConfigArgList, $reservedArgList);
	
	foreach($matchedArgList as $matchedArg) {
		switch($matchedArg) {
			case '$productNid':
			case '$tariffplanNid' :
			case '$voucherCardTypeNid' :
				$newArgString = str_replace($matchedArg, $args['rootId'], $newArgString);
				break;
			case '$nid':
			case '$refTreeTid':
				$newArgString = str_replace($matchedArg, $args['id'], $newArgString);
				break;			
			case '[arg]':
				$collectionName = 'field_qtabs_click_arguments';
				$result = _get_view_result_qtabConfgNid($collectionName, $args);
				
				if(!empty($result)) {
					$newArgString = str_replace($matchedArg, join(',', $result), $newArgString);
				} else {
					$newArgString = str_replace('/'.$matchedArg, '', $newArgString);
				}
				break;
				
			case '[Exclude]':
				$collectionName = 'field_qtabs_right_click_exclude';
				$result = _get_view_result_qtabConfgNid($collectionName, $args);
				
				if(!empty($result)) {
					$newArgString = str_replace($matchedArg, join(',', $result), $newArgString);
				} else {
					$newArgString = str_replace('/'.$matchedArg, '', $newArgString);
				}
				break;
				
			case '[Include]':
				$collectionName = 'field_qtabs_right_click_include';
				$result = _get_view_result_qtabConfgNid($collectionName, $args);
				
			
				if(!empty($result)) {
					$newArgString = str_replace($matchedArg, join(',', $result), $newArgString);
				} else {
					$newArgString = str_replace('/'.$matchedArg, '', $newArgString);
				}
				break;
			case '$numberSpecialNid':
				$newArgString = str_replace($matchedArg, $args['rootId'], $newArgString);
				break;
            case '$numberSpecialNidForDetail':
                $newArgString = str_replace($matchedArg, $args['id'], $newArgString);
                break;
			default:
				break;
		}
	}
//dsm($args,'args');
//dsm($newArgString,'new argstring');
	return $newArgString;
}

function _qtabconfig_loading($collectionName, $termInTree) {
	$qtabConfigs = array();
	
	$tempCmd = '$loadingInfos = $termInTree->'.$collectionName."['und'];";
	eval($tempCmd);
	
	foreach($loadingInfos as $loadingInfo) {
		
		$collectionItem = field_collection_item_load($loadingInfo['value']);

		$qtabConfig = array(
			'title' => !empty($collectionItem->field_tab_title)? $collectionItem->field_tab_title['und'][0]['safe_value']: '',
			'type' => !empty($collectionItem->field_tab_type)? $collectionItem->field_tab_type['und'][0]['value']: '',
			'content' => !empty($collectionItem->field_tab_content)? $collectionItem->field_tab_content['und'][0]['safe_value']: '',
			'display' => !empty($collectionItem->field_view_display)? $collectionItem->field_view_display['und'][0]['safe_value']: '',
			'args'	=> !empty($collectionItem->field_view_arguments)? $collectionItem->field_view_arguments['und'][0]['safe_value']: ''  
		);
		$qtabConfigs[$collectionName][] = $qtabConfig;
	}
	return $qtabConfigs;
}

function product_catalog_ajax_load_select_form($nid,$eventType,$rootNid,$relType,$defaultTabIndex=0){
	
	$rootId = explode('_',$rootNid);
	$rootId = $rootId[1];
	$rootNode = node_load($rootId);
	
	$id = explode('_',$nid);
	$nodeOrTerm = $id[0];
	// term 일 경우에만 id 가 term_111_222 형태로 넘어온다. node 일 경우는 node_111 형태임
	// 따라, term 일 경우에만 rootid 를 가장 가까운 상위의 node instance 의 nid로 setting
	if(isset($id[2])){
		$rootId = $id[2];
	}
	//id 를 prefix 제거하고 setting
	$id = $id[1];

	switch($eventType){
		case 'click':
			$targetCollection = 'field_qtabs_click';
			break;
		case 'right_click':
			$targetCollection = 'field_qtabs_right_click';
			break;
	}
	
	switch($nodeOrTerm) {
		case 'node':
			$termInTree = taxonomy_get_term_by_name($relType, 'tpl_node_qtab_info');
			$termInTree = current($termInTree);
			break;
		case 'term':
			$termInTree = taxonomy_term_load($id);
			break;
	}
	
// dsm($termInTree, 'termInTree');
	$qtabConfigs = _qtabconfig_loading($targetCollection, $termInTree);
	
	$qtabs = array();
    $weight = 0;
    
    $index = 0;
	$qtabIndex = 0;
	
    foreach($qtabConfigs[$targetCollection] as $qtabConfig) {

		if(isset($qtabConfig['args'])) {
			$args = array(
					'qtabIndex' => $qtabIndex,
					'termInTree' => $termInTree,
					'id' => $id,
					'rootId' => $rootId
			);
            $newArgs = _replace_arguments($qtabConfig['args'],  $qtabConfig, $args);
		}else {
			$newArgs = array();
		}
		
		switch($qtabConfig['type']) {
            case 'node':
            	break;
            	
            case 'block':
            	break;
            	
            case 'view':
				
            	$qtabs[] = array(
                    'title' => $qtabConfig['title'],
                    'type' => 'view',
                    'vid' => $qtabConfig['content'],
                    'display' => $qtabConfig['display'],
                	'args' => $newArgs,
                	'weight' => $weight
                );
            	break;
            	
            case 'callback':
				
				// treenodecounter에서 선불이 PostPaid일 때에는 필요없음.
				if($nodeOrTerm == 'node') {
					if($relType == 'tree_node_counter_main_basic' || $relType == 'tree_node_counter_main_optional') {
						$treeNodeCounter = node_load($id);
						$refCounter = node_load($treeNodeCounter->field_ref_counter['und'][0]['nid']);
						$billingTypeCounter = taxonomy_term_load($refCounter->field_billing_type_counter['und'][0]['tid']);
						if($billingTypeCounter->name == 'Prepaid') continue;
					}
				}
				$args = array(
            			'qtabIndex' => $qtabIndex,
            			'termInTree' => $termInTree,
            			'id' => $id,
            			'rootId' => $rootId
            	);
            	$newArgs = _replace_arguments($qtabConfig['content'], $qtabConfig, $args);
				
            	$qtabs[] = array(
            		'title' => $qtabConfig['title'],
            		'type' => 'callback',
            		'path' => $newArgs,
            		'weight' => $weight
            	);				
				break;
        }
        $weight = $weight + 1;
        $qtabIndex = $qtabIndex + 1;
    }
	
    $qtoptions = array(
    	'ajax' => FALSE,
    	'style' => 'zen',
    	//'renderer' => 'ui_tabs'
    );
	
	if(isset($defaultTabIndex)) {
		$qtoptions['default_tab'] = $defaultTabIndex;
    }
	
    $quicktabs = quicktabs_build_quicktabs('qtab_dummy',$qtoptions,$qtabs);
    $qtRender =  drupal_render($quicktabs['content']);

    $renderOutput = '<div id="tree_content_div" style="overflow:scroll;height:700px;">'.$qtRender.'</div>';
    $output[] = $renderOutput;
    $output = ajax_render($output);
    
// dsm($output,'output');
    
    print $output;
    exit;
}

function product_catalog_ajax_move_node($js = NULL ) {

    $nodes = $_POST['nodes'];
    $parent = $_POST['parent'];

    foreach($nodes as $node) {
    	$tempArr = explode('_', $node['nid']);
    	$nid = $tempArr[1];    	
    	$temp_node = node_load($nid);    	
    	$temp_node->field_weight['und'][0]['value'] = $node['weight'];
        node_save($temp_node);       
    }

    if($parent['changed'] == 'true') {    	
        $temp_node = node_load($nodes[0]['nid']);
        $temp_node->field_parent_node['und'][0]['nid'] = $parent['nid'];
        node_save($temp_node);
    }

    print json_encode("{'return' : true}");    
    exit;
}

function product_catalog_ajax_load_tree($js = NULL, $rootNid) {

    //dsm(date('H:i:s'));
    //$children = get_children($rootNid);
    $rootNode = node_load($rootNid);
    switch($rootNode->type){
		case 'simpleproductoffering':
		case 'vouchercardtype':
		case 'number_special':
		   	$children = _load_tree_item_mixed_with_node_and_term($rootNode);	    	
	    break;
		default:
	    	$children = get_children_stored_procedure($rootNid);
	    break;
	}
    //dsm($children,'children'); 
    print json_encode($children); 
    //dsm(date('H:i:s'));    
    exit;
}


function product_catalog_ajax_add_content($js = NULL) {
	global $user;
	ctools_include('node.pages', 'node', '');
	ctools_include('ajax');

	$rootId = $_POST['root_id'];
	$rootNid = explode('_',$rootId);
	$rootNid = $rootNid[1];
	$parentId = $_POST['parent_id'];
	$parentNid = explode('_',$parentId);
	$refTreeNid = isset($parentNid[2])?$parentNid[2]:NULL;
	$parentType = $parentNid[0];
	$parentNid = $parentNid[1];
	$childContentType = $_POST['child_content_type'];
	$maxWeight = $_POST['max_weight'];
	$usageType = $_POST['usage_type'];
	$nonUsageType = $_POST['nonusage_type'];
	
	$weightStep = 100;
	$weight = $maxWeight + $weightStep;

	switch ($childContentType){
        case 'conditionwhatusagetypefactors':        	 
			$child = new StdClass();
    		$child->uid = $user->uid;
    		$child->type = $childContentType;
    		$child->language = 'und';
    		$child->field_parent_node = array('und' => array(0 => array('nid' => $parentNid)));
    		$child->field_weight = array('und' => array(0 => array('value' => $weight)));

            $usageTypeTerm = taxonomy_get_term_by_name($usageType, 'usagetype');
			$child->field_ref_usage_type = array('und' => array(0 => array('tid' => current($usageTypeTerm)->tid)));
            
            node_save($child);

            // js tree node add function call
    		$output = array('parent_id' => $parentId, 'child_id' => 'node_'.$child->nid,'title' => $child->title, 'node_type' => $child->type, 'weight' => $weight);
    		print json_encode($output);
    		exit;
            break;
			
		case 'conditionwhatnonusagetypefactors':        	 
			$child = new StdClass();
    		$child->uid = $user->uid;
    		$child->type = $childContentType;
    		$child->language = 'und';
    		$child->field_parent_node = array('und' => array(0 => array('nid' => $parentNid)));
    		$child->field_weight = array('und' => array(0 => array('value' => $weight)));

            $nonUsageTypeTerm = taxonomy_get_term_by_name($nonUsageType, 'nonusagetype');
			$child->field_ref_nonusage_type = array('und' => array(0 => array('tid' => current($nonUsageTypeTerm)->tid)));
			node_save($child);

            // js tree node add function call
    		$output = array('parent_id' => $parentId, 'child_id' => 'node_'.$child->nid,'title' => $child->title, 'node_type' => $child->type, 'weight' => $weight);
    		print json_encode($output);
    		exit;
            break;
            
    	case 'conditioncommonor':
    	case 'conditioncommonand':
        case 'conditionwhatincomingcall':
		case 'conditionwhenfirstmonth':
		case 'conditionwhencustomerbirthday':
		case 'conditionwhencompanybirthday':
    		// create without popup
    		$child = new StdClass();
    		$child->uid = $user->uid;
    		$child->type = $childContentType;
    		$child->language = 'und';
    		$child->field_parent_node = array('und' => array(0 => array('nid' => $parentNid)));
    		$child->field_weight = array('und' => array(0 => array('value' => $weight)));
    		node_save($child);

    		// js tree node add function call
    		$output = array('parent_id' => $parentId, 'child_id' => 'node_'.$child->nid,'title' => $child->title, 'node_type' => $child->type, 'weight' => $weight);
    		print json_encode($output);
    		exit;
    		break;
			
		default:    		
    		if($refTreeNid == NULL) $refTreeNid = $parentNid;
    		$qtabs = array();
    		
    		$path = 'tree/create/'.$childContentType.'/'.$parentType.'/'.$parentNid.'/'.$weight.'/'.$rootNid.'/'.$refTreeNid;
			//dsm($path,'path');
			$qtabs[] = array(
    				'title' => 'Add',
    				'type' => 'callback',
    				'path' => $path,
    				'weight' => 0
    		);
    		$qtoptions = array(
    				'ajax' => FALSE,
    				'style' => 'zen',
    		);
    		
    		$quicktabs = quicktabs_build_quicktabs('qtab_dummy',$qtoptions,$qtabs);
    		$qtRender =  drupal_render($quicktabs['content']);
    		
			$renderOutput = '<div id="tree_content_div" style="overflow:scroll;height:700px;">'.$qtRender.'</div>';
			$output[] = $renderOutput;
			$output = ajax_render($output);
			print $output;
		    exit; 
    		break;
    }    
}

function product_catalog_ajax_delete_from_tree($js = NULL){
	ctools_include('node.pages', 'node', '');
	ctools_include('ajax');
	
	$deleteNodes = $_POST['nodes'];
	
	$deleteNids = array();
	foreach($deleteNodes as $delItem){
		$delItem = explode('_',$delItem);
		if($delItem[0] == 'node'){
			$deleteNids[] = $delItem[1];
		}
	}
	
	node_delete_multiple($deleteNids);
	
	$output = array('return' => true);

	print json_encode($output);
	exit;
}

function product_catalog_ajax_edit_content($js = NULL, $contentType, $nodeNid) {
	module_load_include('inc','node','node.pages');
	$nodeNid = explode('_',$nodeNid);
	$nodeNid = $nodeNid[1];
	
    $qtabs = array();
    $path = 'tree/edit/'.$nodeNid;
    
    $qtabs[] = array(
    		'title' => 'Edit',
    		'type' => 'callback',
    		'path' => $path,
    		'weight' => 0
    );
    $qtoptions = array(
    		'ajax' => FALSE,
    		'style' => 'zen',
    );
    
    $quicktabs = quicktabs_build_quicktabs('qtab_dummy',$qtoptions,$qtabs);
    $qtRender =  drupal_render($quicktabs['content']);
    
    $renderOutput = '<div id="tree_content_div" style="overflow:scroll;height:700px;">'.$qtRender.'</div>';
    $output[] = $renderOutput;
	$output = ajax_render($output);
	print $output;
    exit;    
}

function product_catalog_modal_form_view($formName,$param1=NULL){
	ctools_include('node.pages', 'node', '');
	ctools_include('modal');
	ctools_include('ajax');
	
	$param = array();
	switch($formName){
		case 'timetable_selectable_form':
			$param['timetable_nid'] = $param1;
			$param['editable'] = FALSE;
			break;
		case 'numberingplan_domestic_view_form':
		case 'numberingplan_idd_view_form':
        case 'roamingplan_view_form':
			$param['plan_nid'] = $param1;
			break;
		case 'depositscheme_view_form':
			$param['depositscheme_nid'] = $param1;
			break;
		case 'thresholdscheme_view_form':
			$param['thresholdscheme_nid'] = $param1;
			break;
	}
		
	$form_state = array(
		'ajax' => TRUE,
		'param' => $param
	);
	
	$output = ctools_modal_form_wrapper($formName, $form_state);
	
	switch($formName){
		case 'timetable_selectable_form':
			$output[] = ajax_command_invoke(NULL, 'disableSelectable');
			break;
	}
	
	print ajax_render($output);
	exit;
}

function product_catalog_modal_view_link($content_type, $nid){
	
	// product_catalog_modal_form_view('depositscheme_view_form');
	ctools_include('node.pages', 'node', '');
	ctools_include('modal');
	ctools_include('ajax');
	
	if($content_type == 'treenodelifecyclescheme') {
		$qtabs = array(
		 	'0' => array( 'title' => 'Permission',
					'type' => 'view',
					'vid'  => 'ocs_svc_perm',
					'display' => 'panel_pane_3',
					'args' => $nid 
				),
			'1' => array( 'title' => 'Transition Rules',
						'type' => 'view',
						'vid' 	=> 'ocs_state_machine',
						'display' => 'panel_pane_2',
						'args'	=> $nid
				),
		);
	}
	
	$qtoptions = array(
    	'ajax' => FALSE,
    	'style' => 'zen',
    	'renderer' => 'ui_tabs'
    );
	
	/*
	if(isset($defaultTabIndex)) {
		$qtoptions['default_tab'] = $defaultTabIndex;
    }
	 */
	
    $quicktabs = quicktabs_build_quicktabs('qtab_dummy',$qtoptions,$qtabs);
    $qtRender =  drupal_render($quicktabs['content']);
	$renderOutput = '<div id="tree_content_div" style="overflow:scroll;height:700px;">'.$qtRender.'</div>';
	
	$output = array();
	$output[] = ctools_modal_command_display('Subscriber Lifecycle Scheme', $renderOutput);
	$output = ajax_render($output);
	print $output;
	exit;
}

function product_catalog_modal_form_edit_modal_content($js = NULL, $contentType, $nodeNid, $refNodeNid = NULL, $refTreeTid = NULL) {
    ctools_include('node.pages', 'node', '');
    ctools_include('modal');
    ctools_include('ajax');
	
    $node = node_load($nodeNid);
	
	$form_state = array();
	switch($contentType) {
		case 'actionsetcounter':
		case 'actionsetcounteronbonus':
			$refNode = node_load($refNodeNid);
			$form_state['product_nid'] = $refNode->field_ref_product['und'][0]['nid'];
			break;
	}
	
	if (!$js) {
        return drupal_get_form($contentType . '_node_form', $node);
    }

    $form_state['ajax'] = TRUE;
	$form_state['build_info']['args'] = array($node);
	
    $output = ctools_modal_form_wrapper($contentType . '_node_form', $form_state);

    if (!empty($form_state['executed'])) {
        $output = array();
        $output[] = ctools_modal_command_dismiss();
		
        switch($node->type){
        	case 'rate':
        		$refNodeNid = $node->field_ref_tariffplan['und'][0]['nid'];
        		$refTreeTid = $node->field_ref_tree_tid['und'][0]['value'];
        		$output[] = _add_command_after_dismiss_modal($refNodeNid,$refTreeTid);
        		break;
        	case 'loyaltypointfactors':
        		
        		$output[] = _add_command_after_dismiss_modal($refNodeNid,$refTreeTid);
        		break;
        	case 'numberspecialfactors':
        		$output[] = _add_command_after_dismiss_modal($refNodeNid,$refTreeTid);
				break;	
        	case 'domestic_ratinggroup':
        	case 'idd_ratinggroup':
            case 'roaming_ratinggroup':
        	case 'depositschemefactors':
        	case 'depositschemeadjustment':
        	case 'thresholdschemefactors':
			case 'holidaylist_specific':
			case 'holidaylist_repeatable':
        	case 'area_code':
        		$output[] = ctools_ajax_command_reload();
				break;
			case 'actionsetcounter':
			case 'actionsetcounteronbonus':
				$defaultTabIndex = $refTreeTid;
				$refTreeTid = NULL;
				$output[] = _add_command_after_dismiss_modal($refNodeNid,$refTreeTid,$defaultTabIndex);
				break;
        }
        
    }else{
    	if($contentType == 'rate'){
    		$output[] = ajax_command_invoke(NULL, 'drawFlotLinkInit');
    	}
    }
//dsm($output,'modal output');
    print ajax_render($output);
    exit;
}

function product_catalog_ajax_delete_from_view($nodeNid, $refNodeNid, $defaultTabIndex){
	ctools_include('node.pages', 'node', '');
	ctools_include('ajax');
		
	$node = node_load($nodeNid);
	$output = array();

	switch($node->type){
		case 'rate':
		case 'numberspecialfactors';
			$output[] = _add_command_after_dismiss_modal($refNodeNid,$defaultTabIndex);
			break;
		case 'domestic_ratinggroup':
		case 'idd_ratinggroup':
        case 'roaming_ratinggroup':
		case 'depositschemefactors':
		case 'depositschemeadjustment':
		case 'thresholdschemefactors':
		case 'area_code':
		case 'holidaylist_repeatable':
		case 'holidaylist_specific':
			$output[] = ctools_ajax_command_reload();
			break;
		case 'actionsetcounter':
		case 'actionsetcounteronbonus':
			$output[] = _add_command_after_dismiss_modal($refNodeNid,NULL,$defaultTabIndex);
			break;
	}
	
	node_delete($nodeNid);		
	print ajax_render($output);
	//print json_encode($output);
	exit;
}
?>
